# 电子时钟项目说明文档

这是一个基于STM32F10x单片机开发的电子时钟项目，包括单片机端和Android应用端，通过蓝牙实现通信控制功能。

## 目录
- [项目概述](#项目概述)
- [硬件部分 (STM32)](#硬件部分-stm32)
  - [硬件连接](#硬件连接)
  - [关键功能模块](#关键功能模块)
  - [按键消抖机制](#按键消抖机制)
- [软件部分 (Android)](#软件部分-android)
  - [应用功能](#应用功能)
  - [界面说明](#界面说明)
  - [核心类介绍](#核心类介绍)
- [通信协议](#通信协议)
  - [数据包格式](#数据包格式)
  - [命令说明](#命令说明)
  - [校验机制](#校验机制)
- [注意事项](#注意事项)

## 项目概述

本项目是一个完整的电子时钟系统，由以下部分组成：
- **STM32F10x硬件端**：实现时间显示、温度显示、按键操作等基本功能
- **Android应用端**：提供蓝牙连接、远程控制、数据监控等扩展功能

两部分通过蓝牙串口通信实现数据交互，可以远程调整时钟时间、查询温度等。

## 硬件部分 (STM32)

### 硬件连接

#### 按键模块
- 使用GPIOA的8-11引脚连接4个按键
- 按键配置为上拉输入模式
- 按键引脚映射：
  - 按键0：GPIOA.8
  - 按键1：GPIOA.9
  - 按键2：GPIOA.10
  - 按键3：GPIOA.11

#### OLED显示模块
- 使用I2C通信方式
- 引脚配置：
  - SCL：GPIOB.8（时钟线）
  - SDA：GPIOB.9（数据线）
- 配置为开漏输出模式

#### 串口通信模块
- 使用USART2
- 引脚配置：
  - TX：GPIOA.2（发送）
  - RX：GPIOA.3（接收）
- 配置参数：
  - 波特率：115200
  - 8位数据位，1位停止位，无校验

### 关键功能模块

#### 时间显示与设置
- `UpdateTimeDisplay()`：更新OLED上的时间和温度显示
- `HandleTimeSetting(uint8_t increment)`：处理时间设置，增加或减少选中的时间项

#### 按键处理
- `Key_Nums()`：处理按键事件，根据按键动作执行对应功能
- 支持单击、双击和长按事件

#### 串口通信
- `Serial_SendPacket()`：发送数据包到上位机
- `USART_data()`：处理接收到的串口数据包

### 按键消抖机制

采用软件状态机实现按键消抖，包含以下状态：
1. 空闲状态
2. 消抖状态
3. 确认按下状态
4. 确认长按状态
5. 等待再次按下状态
6. 第二次按下状态

支持的按键事件：
- 单击事件
- 双击事件
- 长按事件

## 软件部分 (Android)

### 应用功能

Android应用主要功能：
- 扫描并连接蓝牙设备
- 发送各种控制命令（获取/设置时间、获取/复位温度等）
- 接收并显示来自设备的数据
- 保存上次连接的设备信息

### 界面说明

#### 测试界面 (BluetoothTestActivity)
主要控件：
- 连接/断开按钮
- 快速连接按钮
- 温度获取/重置按钮
- 时间获取/重置/设置按钮
- 自定义时间输入框
- 数据显示区域
- 日志清除按钮

#### 连接界面 (BluetoothConnectActivity)
主要控件：
- 连接/断开按钮
- 跳转到测试界面按钮
- 连接状态显示
- 日志显示区域
- 日志清除按钮

### 核心类介绍

#### BluetoothDataManager
蓝牙通信的核心类，实现与设备的数据收发功能。

主要方法：
- `connect(BluetoothDevice device)`：连接指定蓝牙设备
- `disconnect()`：断开当前连接
- `sendData(byte command, byte[] data)`：发送命令和数据
- `isConnected()`：检查连接状态
- `getConnectedDevice()`：获取当前连接的设备
- `setOnDataReceivedListener()`：设置数据接收监听器
- `setOnConnectionStateChangeListener()`：设置连接状态变化监听器

#### 其他重要类
- `BluetoothTestActivity`：测试界面实现
- `BluetoothConnectActivity`：连接界面实现
- `BluetoothDataExample`：蓝牙数据管理示例类

## 通信协议

### 数据包格式

数据包固定为8字节，格式如下：
```
55 01 XX YY YY YY CC AA
```

各字节含义：
- `55`：数据头（固定）
- `01`：版本号（固定）
- `XX`：主命令
- `YY YY YY`：三个数据位
- `CC`：校验位 = (主命令 + 三个数据位) % 256
- `AA`：数据尾（固定）

### 命令说明

#### 时间相关命令
- **时间校准命令(0x01)**
  - 数据1：小时值（0-23）
  - 数据2：分钟值（0-59）
  - 数据3：秒值（0-59）

#### 温度相关命令
- **温度校准命令(0x02)**
  - 数据1：温度整数部分
  - 数据2：温度小数部分（乘以100）
  - 数据3：符号位（0xFF表示正数，其他值表示负数）

### 校验机制

校验和计算方法：(主命令 + 数据1 + 数据2 + 数据3) % 256

## 注意事项

### Android应用权限
应用需要以下蓝牙相关权限：
- BLUETOOTH
- BLUETOOTH_ADMIN
- BLUETOOTH_CONNECT（Android 12+）
- BLUETOOTH_SCAN（Android 12+）
- ACCESS_FINE_LOCATION（用于蓝牙扫描）
- ACCESS_COARSE_LOCATION（用于蓝牙扫描）

### 硬件注意事项
- 按键使用上拉输入模式，按下时为低电平
- OLED使用I2C通信，需要上拉电阻
- 通信波特率为115200，需要确保双方一致
